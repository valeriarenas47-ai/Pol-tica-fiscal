<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Simulador de Políticas: Fiscal y Monetaria</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Chart.js Annotation Plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3"></script>
  <meta name="description" content="Simulador educativo: ingresos públicos, gasto (% PIB), equilibrio fiscal, deuda con tendencia, IPC constante, IDH, PIB per cápita y Gini. Archivo único para Netlify." />
  <style>
    .card { box-shadow: 0 8px 30px rgba(0,0,0,0.08); }
    .grid-autofit { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px,1fr)); gap:1rem; }
    .number-input { appearance:textfield; }
    .number-input::-webkit-outer-spin-button, .number-input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
    .badge { font-size: .7rem; padding:.15rem .5rem; border-radius:.5rem; }
  </style>
</head>
<body class="bg-slate-50 text-slate-800">
  <header class="sticky top-0 z-10 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <h1 class="text-2xl md:text-3xl font-semibold">Simulador Fiscal y Monetario</h1>
      <button id="btnExport" class="px-3 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 text-sm">Exportar escenario (.json)</button>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 py-6">
    <section class="mb-6 p-4 card rounded-2xl bg-white">
      <h2 class="text-xl font-semibold mb-2">Descripción</h2>
      <p class="text-sm text-slate-600">Archivo único listo para Netlify. Proyecta <strong>ingresos</strong>, <strong>gasto público</strong> (incluye <strong>% del PIB</strong>), <strong>punto de equilibrio</strong>, <strong>déficit/superávit</strong>, <strong>deuda</strong> (con tendencia desde el nivel inicial), <strong>IPC</strong> (constante según tu entrada), y efectos aproximados en <strong>IDH</strong>, <strong>PIB per cápita</strong> e <strong>Índice de Gini</strong>. Modelo heurístico didáctico.</p>
    </section>

    <!-- Parámetros globales -->
    <section class="mb-6 p-4 card rounded-2xl bg-white">
      <h2 class="text-xl font-semibold mb-4">1) Supuestos macro iniciales</h2>
      <div class="grid-autofit">
        <label class="block">PIB inicial (USD)
          <input id="gdp0" type="number" class="number-input mt-1 w-full rounded-xl border-slate-300" value="200000000000" />
        </label>
        <label class="block">Población (millones)
          <input id="pop" type="number" step="0.1" class="number-input mt-1 w-full rounded-xl border-slate-300" value="19.5" />
        </label>
        <label class="block">Deuda pública inicial (% del PIB)
          <input id="debt0" type="number" step="0.1" class="number-input mt-1 w-full rounded-xl border-slate-300" value="40" />
        </label>
        <label class="block">Tendencia de deuda desde el nivel inicial
          <select id="debtTrend" class="mt-1 w-full rounded-xl border-slate-300">
            <option value="plano" selected>Plana</option>
            <option value="progresivo">Progresiva (↑)</option>
            <option value="regresivo">Regresiva (↓)</option>
          </select>
        </label>
        <label class="block">Inflación (IPC anual, %) — constante
          <input id="inflation" type="number" step="0.1" class="number-input mt-1 w-full rounded-xl border-slate-300" value="4" />
        </label>
        <label class="block">Horizonte (años)
          <input id="horizon" type="number" class="number-input mt-1 w-full rounded-xl border-slate-300" value="5" min="2" max="30" />
        </label>
      </div>
    </section>

    <!-- Políticas -->
    <section class="mb-6 p-4 card rounded-2xl bg-white">
      <h2 class="text-xl font-semibold mb-4">2) Controles de política</h2>
      <div class="grid lg:grid-cols-3 gap-6">
        <!-- Fiscal core -->
        <div>
          <h3 class="text-lg font-semibold mb-2">Fiscal</h3>
          <div class="grid-autofit">
            <label class="block">Ingresos públicos totales (USD, año 1)
              <input id="revenueY1" type="number" class="number-input mt-1 w-full rounded-xl border-slate-300" value="46000000000" />
            </label>
             <label class="block">Carga tributaria objetivo (% del PIB)
              <input id="taxBurden" type="number" step="0.1" class="number-input mt-1 w-full rounded-xl border-slate-300" value="23" />
            </label>
          </div>

        <!-- Transición de postura fiscal -->
        <div>
          <h3 class="text-lg font-semibold mb-2">Transición de postura fiscal</h3>
          <div class="grid-autofit">
            <label class="block">Postura inicial
              <select id="fiscalStart" class="mt-1 w-full rounded-xl border-slate-300">
                <option value="expansiva">Expansiva</option>
                <option value="contractiva">Contractiva</option>
              </select>
            </label>
            <label class="block">Postura final
              <select id="fiscalEnd" class="mt-1 w-full rounded-xl border-slate-300">
                <option value="expansiva">Expansiva</option>
                <option value="contractiva" selected>Contractiva</option>
              </select>
            </label>
            <label class="block">Años de transición (5–10)
              <input id="fiscalYears" type="number" min="5" max="10" value="7" class="number-input mt-1 w-full rounded-xl border-slate-300" />
            </label>
            <label class="block">Tendencia del gasto fiscal (%PIB)
              <select id="spendTrend" class="mt-1 w-full rounded-xl border-slate-300">
                <option value="plana" selected>Plana</option>
                <option value="progresiva">Progresiva (↑)</option>
                <option value="regresiva">Regresiva (↓)</option>
              </select>
            </label>
          </div>
        </div>

        <!-- Monetaria -->
        <div>
          <h3 class="text-lg font-semibold mb-2">Monetaria</h3>
          <div class="grid-autofit">
            <label class="block">Tasa de política monetaria (TPM, %)
              <input id="policyRate" type="number" step="0.25" class="number-input mt-1 w-full rounded-xl border-slate-300" value="5.5" />
            </label>
            <label class="block">Encaje bancario (% de depósitos)
              <input id="reserveReq" type="number" step="0.5" class="number-input mt-1 w-full rounded-xl border-slate-300" value="9" />
            </label>
          </div>
        </div>
      </div>

      <div class="mt-4 flex gap-3">
        <button id="btnRun" class="px-4 py-2 rounded-xl bg-emerald-600 text-white hover:bg-emerald-700">Calcular proyección</button>
        <button id="btnReset" class="px-4 py-2 rounded-xl bg-slate-200 hover:bg-slate-300">Restablecer</button>
      </div>
    </section>

    <!-- Resultados -->
    <section id="results" class="hidden space-y-6">
      <div class="p-4 card rounded-2xl bg-white">
        <h2 class="text-xl font-semibold mb-3">3) Resumen del escenario</h2>
        <div id="summary" class="text-sm grid md:grid-cols-3 gap-4"></div>
      </div>

      <div class="grid lg:grid-cols-2 gap-6">
        <div class="p-4 card rounded-2xl bg-white">
          <h3 class="text-lg font-semibold mb-2">Ingresos vs. Gasto público</h3>
          <canvas id="chartRevExp" height="220"></canvas>
          <div class="mt-2 text-xs text-slate-500" id="breakevenNote"></div>
        </div>
        <div class="p-4 card rounded-2xl bg-white">
          <h3 class="text-lg font-semibold mb-2">Saldo fiscal (USD)</h3>
          <canvas id="chartBalance" height="220"></canvas>
        </div>
      </div>

      <div class="grid lg:grid-cols-2 gap-6">
        <div class="p-4 card rounded-2xl bg-white">
          <h3 class="text-lg font-semibold mb-2">Gasto público (% del PIB)</h3>
          <canvas id="chartSpendPct" height="200"></canvas>
        </div>
        <div class="p-4 card rounded-2xl bg-white">
          <h3 class="text-lg font-semibold mb-2">Deuda pública (% del PIB)</h3>
          <canvas id="chartDebt" height="200"></canvas>
        </div>
      </div>

      <div class="grid lg:grid-cols-3 gap-6">
        <div class="p-4 card rounded-2xl bg-white">
          <h3 class="text-lg font-semibold mb-2">PIB per cápita (USD)</h3>
          <canvas id="chartGDPpc" height="200"></canvas>
        </div>
        <div class="p-4 card rounded-2xl bg-white">
          <h3 class="text-lg font-semibold mb-2">Índice de Gini (↓ menor desigualdad)</h3>
          <canvas id="chartGini" height="200"></canvas>
        </div>
        <div class="p-4 card rounded-2xl bg-white">
          <h3 class="text-lg font-semibold mb-2">IDH (0–1)</h3>
          <canvas id="chartHDI" height="200"></canvas>
        </div>
      </div>

      <div class="p-4 card rounded-2xl bg-white">
        <h3 class="text-lg font-semibold mb-2">Inflación (IPC anual)</h3>
        <canvas id="chartCPI" height="200"></canvas>
      </div>

      <div class="p-4 card rounded-2xl bg-white overflow-x-auto">
        <h3 class="text-lg font-semibold mb-3">Tabla de proyección (valores aproximados)</h3>
        <table class="min-w-full text-sm">
          <thead>
            <tr class="border-b">
              <th class="text-left py-2 pr-4">Año</th>
              <th class="text-right py-2 pr-4">PIB (USD)</th>
              <th class="text-right py-2 pr-4">Ingresos (USD)</th>
              <th class="text-right py-2 pr-4">Gasto (USD)</th>
              <th class="text-right py-2 pr-4">Gasto %PIB</th>
              <th class="text-right py-2 pr-4">Saldo (USD)</th>
              <th class="text-right py-2 pr-4">Deuda (%PIB)</th>
              <th class="text-right py-2 pr-4">PIB pc</th>
              <th class="text-right py-2 pr-4">Gini</th>
              <th class="text-right py-2 pr-4">IDH</th>
              <th class="text-right py-2 pr-4">IPC %</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
      </div>

      <div class="p-4 card rounded-2xl bg-white">
        <h3 class="text-lg font-semibold mb-2">Notas del modelo (supuestos simplificados)</h3>
        <ul class="list-disc pl-5 text-sm text-slate-600 space-y-1">
          <li>Gasto %PIB = base 21% ± postura fiscal (transición 5–10 años) con tendencia plana/progresiva/regresiva.</li>
          <li>Ingresos: introduces el nivel del <strong>año 1</strong>; el simulador mantiene esa <em>relación ingresos/PIB</em> constante a lo largo del horizonte.</li>
          <li>IPC es el valor constante que definas. La deuda evoluciona por saldo fiscal y por la <strong>tendencia de deuda</strong> desde su nivel inicial.</li>
        </ul>
      </div>
    </section>
  </main>

  <footer class="max-w-7xl mx-auto px-4 pb-10 text-xs text-slate-500">
    <p>© 2025 Simulador educativo. Uso didáctico, no sustituye modelos econométricos formales.</p>
  </footer>

  <script>
    // ===== Utilidades =====
    const fmt = new Intl.NumberFormat('es-CL', { maximumFractionDigits: 0 });
    const fmt2 = new Intl.NumberFormat('es-CL', { maximumFractionDigits: 2 });

    function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
    function lerp(a,b,t){ return a + (b-a)*t; }

    function readInputs(){
      return {
        gdp0: parseFloat(document.getElementById('gdp0').value || 0),
        pop: parseFloat(document.getElementById('pop').value || 0),
        debt0: parseFloat(document.getElementById('debt0').value || 0),
        debtTrend: document.getElementById('debtTrend').value,
        inflation: parseFloat(document.getElementById('inflation').value || 0)/100,
        horizon: parseInt(document.getElementById('horizon').value || 5),

        revenueY1: parseFloat(document.getElementById('revenueY1').value || 0),
        greenIncentives: parseFloat(document.getElementById('greenIncentives').value || 0)/100,

        policyRate: parseFloat(document.getElementById('policyRate').value || 0)/100,
        reserveReq: parseFloat(document.getElementById('reserveReq').value || 0)/100,

        fiscalStart: document.getElementById('fiscalStart').value,
        fiscalEnd: document.getElementById('fiscalEnd').value,
        fiscalYears: parseInt(document.getElementById('fiscalYears').value || 7),
        spendTrend: document.getElementById('spendTrend').value,
      };
    }

    // Tendencias lineales: progresiva (+10% relativo al final), regresiva (-10%), plana (0)
    function applyTrend(value0, trend, t){
      const relEnd = trend==='progresiva' ? 1.10 : trend==='regresiva' ? 0.90 : 1.0;
      return lerp(value0, value0*relEnd, t);
    }

    // ===== Núcleo del modelo (heurístico) =====
    function simulate(P){
      const years = Array.from({length: P.horizon}, (_,i)=> i+1);

      // Postura fiscal: offsets sobre gasto %PIB
      const stanceToOffset = (s)=> s==='expansiva' ? 0.025 : -0.02;
      const transYears = clamp(P.fiscalYears, 5, 10);

      // Componentes de crecimiento (base + monetario + fiscal)
      const basePotential = 0.02;
      const rateGap = P.policyRate - P.inflation; // real ex-ante aprox.
      const monPenalty = clamp(rateGap, -0.03, 0.05) * -0.4; // TPM real muy alta frena

      const rows = [];
      let GDP = P.gdp0;
      let popM = P.pop; // millones
      let debtRatio = P.debt0/100;

      // Relación ingresos/PIB a partir del año 1
      const revRatio = P.revenueY1 / P.gdp0; // constante

      // Ajuste de política de deuda (±0.3 pp del PIB por año) desde el nivel inicial
      const debtAdj = P.debtTrend==='progresivo' ? +0.003 : P.debtTrend==='regresivo' ? -0.003 : 0.0;

      years.forEach((yr, idx)=>{
        const t = years.length>1 ? idx/(years.length-1) : 1.0;
        // Transición de postura fiscal
        const stanceOffset = lerp(stanceToOffset(P.fiscalStart), stanceToOffset(P.fiscalEnd), clamp(idx/(transYears-1), 0, 1));

        const g = clamp(basePotential + monPenalty + (stanceOffset>0? stanceOffset*0.3 : stanceOffset*0.2), -0.03, 0.07);
        GDP = GDP * (1 + g);
        popM = popM * 1.005; // crecimiento demográfico

        // Gasto % del PIB
        let spendRatio0 = clamp(0.21 + stanceOffset, 0.12, 0.35);
        let spendRatio = applyTrend(spendRatio0, P.spendTrend, t);

        const revenues = revRatio * GDP; // por construcción
        const spendTotal = spendRatio * GDP * (1 + 0.2*P.inflation) * (1 + 0.1*(popM/P.pop - 1));

        // Saldo fiscal
        const balance = revenues - spendTotal;

        // Deuda
        const primaryNeed = -balance; // >0 si déficit
        const policyDebtNeed = debtAdj * GDP; // ajuste por plan
        const netBorrowing = Math.max(0, primaryNeed + policyDebtNeed) / GDP; // %PIB
        const debtChange = netBorrowing - Math.max(0, -primaryNeed-policyDebtNeed)/GDP;
        debtRatio = clamp(debtRatio + debtChange, 0, 1.5);

        // Indicadores sociales
        const gdpPC = GDP / (popM*1e6);
        const progressivity = clamp((spendRatio - 0.21) * 2, -0.10, 0.12);
        let gini = clamp(0.44 - progressivity, 0.26, 0.60);
        const hdiIncome = clamp((Math.log(gdpPC) - Math.log(2000)) / (Math.log(60000) - Math.log(2000)), 0, 1);
        const socialEffort = clamp(spendRatio*2 + P.greenIncentives*20, 0, 1);
        const hdi = clamp(0.6*hdiIncome + 0.4*socialEffort, 0.35, 0.98);

        // IPC (constante segun entrada)
        const cpi = P.inflation;

        rows.push({ year: yr, GDP, revenues, spendTotal, balance, debtRatio, gdpPC, gini, hdi, spendPct: spendRatio, cpi });
      });

      // Punto(s) de equilibrio: primer cruce
      let beIndex = -1;
      for(let i=1;i<rows.length;i++){
        if((rows[i-1].revenues - rows[i-1].spendTotal) * (rows[i].revenues - rows[i].spendTotal) <= 0){ beIndex = i; break; }
      }

      // Punto de equilibrio año 1 como %PIB necesario
      const y1 = rows[0];
      const neededTaxRatio = clamp((y1.spendTotal / y1.GDP), 0, 0.60);

      return { years, rows, neededTaxRatio, beIndex, revRatio };
    }

    // ===== Render =====
    let chartRevExp, chartDebt, chartGDPpc, chartGini, chartHDI, chartBalance, chartSpendPct, chartCPI;

    function run(){
      const params = readInputs();
      const out = simulate(params);
      document.getElementById('results').classList.remove('hidden');

      // Resumen
      const sum = document.getElementById('summary');
      const growthApprox = (Math.pow(out.rows.at(-1).GDP/params.gdp0, 1/out.rows.length)-1)*100;
      const spend0 = out.rows[0].spendTotal/out.rows[0].GDP*100;
      const rev0 = out.rows[0].revenues/out.rows[0].GDP*100;
      sum.innerHTML = `
        <div>
          <p><strong>Crecimiento anual medio:</strong> ${growthApprox.toFixed(2)}%</p>
          <p><strong>Gasto %PIB (año 1):</strong> ${spend0.toFixed(1)}% <span class="text-slate-500">(tendencia: ${params.spendTrend})</span></p>
        </div>
        <div>
          <p><strong>Ingresos (año 1):</strong> $${fmt.format(params.revenueY1)} <span class="text-slate-500">(${(out.revRatio*100).toFixed(1)}% del PIB)</span></p>
          <p><strong>Punto de equilibrio requerido (año 1):</strong> ${(out.neededTaxRatio*100).toFixed(1)}% del PIB</p>
        </div>
        <div>
          <p><strong>Deuda inicial:</strong> ${fmt2.format(params.debt0)}% del PIB <span class="text-slate-500">(tendencia: ${params.debtTrend})</span></p>
          <p><strong>IPC (constante):</strong> ${fmt2.format(params.inflation*100)}%</p>
        </div>
      `;

      // Tabla
      const tb = document.getElementById('tableBody');
      tb.innerHTML = out.rows.map(r=>`
        <tr class="border-b">
          <td class="py-1 pr-4">${r.year}</td>
          <td class="text-right py-1 pr-4">$${fmt.format(r.GDP)}</td>
          <td class="text-right py-1 pr-4">$${fmt.format(r.revenues)}</td>
          <td class="text-right py-1 pr-4">$${fmt.format(r.spendTotal)}</td>
          <td class="text-right py-1 pr-4">${fmt2.format(r.spendPct*100)}%</td>
          <td class="text-right py-1 pr-4 ${r.balance>=0?'text-emerald-700':'text-rose-700'}">$${fmt.format(r.balance)}</td>
          <td class="text-right py-1 pr-4">${fmt2.format(r.debtRatio*100)}%</td>
          <td class="text-right py-1 pr-4">$${fmt2.format(r.gdpPC)}</td>
          <td class="text-right py-1 pr-4">${fmt2.format(r.gini)}</td>
          <td class="text-right py-1 pr-4">${fmt2.format(r.hdi)}</td>
          <td class="text-right py-1 pr-4">${fmt2.format(r.cpi*100)}%</td>
        </tr>
      `).join('');

      // Gráficos
      const labels = out.rows.map(r=>`Año ${r.year}`);
      const rev = out.rows.map(r=>r.revenues);
      const exp = out.rows.map(r=>r.spendTotal);
      const bal = out.rows.map(r=>r.balance);
      const spendPct = out.rows.map(r=>r.spendPct*100);
      const debt = out.rows.map(r=>r.debtRatio*100);
      const gdppc = out.rows.map(r=>r.gdpPC);
      const gini = out.rows.map(r=>r.gini);
      const hdi = out.rows.map(r=>r.hdi);
      const cpi = out.rows.map(r=>r.cpi*100);

      const ctx1 = document.getElementById('chartRevExp').getContext('2d');
      const ctxBal = document.getElementById('chartBalance').getContext('2d');
      const ctxSpend = document.getElementById('chartSpendPct').getContext('2d');
      const ctx2 = document.getElementById('chartDebt').getContext('2d');
      const ctx3 = document.getElementById('chartGDPpc').getContext('2d');
      const ctx4 = document.getElementById('chartGini').getContext('2d');
      const ctx5 = document.getElementById('chartHDI').getContext('2d');
      const ctxCPI = document.getElementById('chartCPI').getContext('2d');

      if(chartRevExp){ chartRevExp.destroy(); chartBalance.destroy(); chartSpendPct.destroy(); chartDebt.destroy(); chartGDPpc.destroy(); chartGini.destroy(); chartHDI.destroy(); chartCPI.destroy(); }

      // Ingresos vs Gasto con línea de equilibrio (anotación)
      const annotations = {};
      const note = document.getElementById('breakevenNote');
      if(out.beIndex>=0){
        const xLabel = labels[out.beIndex];
        annotations['beLine'] = {
          type: 'line', xMin: out.beIndex + 0.5, xMax: out.beIndex + 0.5, borderWidth: 1, borderColor: 'rgba(0,0,0,0.4)', label:{ enabled:true, content: 'Equilibrio', position:'start' }
        };
        note.textContent = `El equilibrio (ingresos = gasto) ocurre alrededor de ${xLabel}.`;
      } else {
        note.textContent = 'No hay cruce entre ingresos y gasto en el horizonte (déficit o superávit sostenido).';
      }

      chartRevExp = new Chart(ctx1, {
        type:'line', data:{ labels, datasets:[
          { label:'Ingresos', data: rev, fill: '-1' },
          { label:'Gasto', data: exp, fill: false }
        ]}, options:{ responsive:true, plugins:{ legend:{display:true}, annotation:{ annotations } }, scales:{ x:{ grid:{display:false} } } }
      });

      // Saldo fiscal barras con colores condicionales
      chartBalance = new Chart(ctxBal, {
        type:'bar', data:{ labels, datasets:[{ label:'Saldo', data: bal, backgroundColor: bal.map(v=> v>=0? 'rgba(16,185,129,0.5)':'rgba(244,63,94,0.5)') }] },
        options:{ responsive:true, plugins:{ legend:{display:false} }, scales:{ x:{ grid:{display:false} }, y:{ ticks:{ callback:(v)=> '$'+fmt.format(v) } } } }
      });

      const cfgLine = (ctx, label, data)=> new Chart(ctx, {
        type: 'line', data: { labels, datasets: [{ label, data }] }, options: { responsive:true, plugins:{ legend:{display:true} }, scales:{ x:{ grid:{display:false} }, y:{ beginAtZero:false } } }
      });

      chartSpendPct = cfgLine(ctxSpend, 'Gasto %PIB', spendPct);
      chartDebt = cfgLine(ctx2, 'Deuda %PIB', debt);
      chartGDPpc = cfgLine(ctx3, 'PIB per cápita', gdppc);
      chartGini = cfgLine(ctx4, 'Índice de Gini', gini);
      chartHDI = cfgLine(ctx5, 'IDH', hdi);
      chartCPI = cfgLine(ctxCPI, 'IPC %', cpi);
    }

    // Exportar escenario
    function exportScenario(){
      const params = readInputs();
      const out = simulate(params);
      const payload = { params, out, generatedAt: new Date().toISOString() };
      const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'escenario-politicas.json'; a.click();
      URL.revokeObjectURL(url);
    }

    // Reset
    function reset(){
      document.querySelectorAll('input').forEach(el=> el.value = el.defaultValue);
      document.querySelectorAll('select').forEach(el=> el.value = el.querySelector('option[selected]')?.value || el.value);
      document.getElementById('results').classList.add('hidden');
      run();
    }

    document.getElementById('btnRun').addEventListener('click', run);
    document.getElementById('btnReset').addEventListener('click', reset);
    document.getElementById('btnExport').addEventListener('click', exportScenario);

    // Run inicial
    run();
  </script>
</body>
</html>
